<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Kalkulator ΔE2000 - Printing Offset</title>
  <style>
    body { font-family: Arial, sans-serif; margin:20px; background:#f4f6f9; color:#333; }
    h2 { text-align:center; margin-bottom:12px; }
    .container { max-width:600px; margin:auto; background:#fff; padding:18px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
    .section { margin-bottom:16px; }
    .section h3 { margin:0 0 8px 0; font-size:16px; border-bottom:2px solid #eee; padding-bottom:6px; }
    .input-grid { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    .input-grid label { display:block; font-size:13px; margin-bottom:4px; text-align:center; }
    .input-grid input { width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; text-align:center; }
    .controls { text-align:center; margin-top:10px; }
    button { padding:10px 14px; border:none; border-radius:6px; cursor:pointer; font-size:14px; }
    .btn-calc { background:#007bff; color:#fff; margin-right:8px; }
    .btn-reset { background:#dc3545; color:#fff; }
    .result { text-align:center; margin-top:14px; padding:12px; border-radius:8px; font-weight:bold; display:none; }
    .pass { background:#d4edda; color:#155724; }
    .marginal { background:#fff3cd; color:#856404; }
    .fail { background:#f8d7da; color:#721c24; }
    .color-preview { display:flex; justify-content:space-between; margin-top:16px; gap:12px; }
    .color-box { flex:1; height:100px; border-radius:8px; border:2px solid #666;
      display:flex; align-items:center; justify-content:center;
      font-size:16px; font-weight:bold; text-align:center;
      text-shadow:1px 1px 2px rgba(0,0,0,0.5); }
    @media(max-width:600px){
      .color-preview { flex-direction:column; }
      .color-box { height:120px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Kalkulator ΔE2000 - Printing Offset</h2>

    <div class="section">
      <h3>Standar (Target)</h3>
      <div class="input-grid">
        <div><label for="L1">L*</label><input id="L1" type="number" step="0.01"></div>
        <div><label for="a1">a*</label><input id="a1" type="number" step="0.01"></div>
        <div><label for="b1">b*</label><input id="b1" type="number" step="0.01"></div>
      </div>
    </div>

    <div class="section">
      <h3>Sampel (Cetakan)</h3>
      <div class="input-grid">
        <div><label for="L2">L*</label><input id="L2" type="number" step="0.01"></div>
        <div><label for="a2">a*</label><input id="a2" type="number" step="0.01"></div>
        <div><label for="b2">b*</label><input id="b2" type="number" step="0.01"></div>
      </div>
    </div>

    <div class="section">
      <label>Toleransi QC (default 2.0):</label>
      <input id="tolerance" type="number" value="2.0" step="0.1" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; text-align:center;">
    </div>

    <div class="controls">
      <button class="btn-calc" onclick="hitung()">Hitung ΔE2000</button>
      <button class="btn-reset" onclick="resetInput()">Reset Input</button>
    </div>

    <div id="hasil" class="result"></div>

    <div class="color-preview">
      <div id="color1" class="color-box" style="background:#ffffff; color:#000;">Standar</div>
      <div id="color2" class="color-box" style="background:#ffffff; color:#000;">Sampel</div>
    </div>
  </div>

<script>
  /* Lab -> sRGB */
  function LabToRGB(L, a, b) {
    var fy = (L + 16) / 116;
    var fx = fy + a / 500;
    var fz = fy - b / 200;

    function pivot(v) {
      var v3 = Math.pow(v, 3);
      return v3 > 0.008856 ? v3 : (v - 16/116) / 7.787;
    }

    var xr = pivot(fx);
    var yr = pivot(fy);
    var zr = pivot(fz);

    var X = xr * 95.047;
    var Y = yr * 100.000;
    var Z = zr * 108.883;

    X = X / 100; Y = Y / 100; Z = Z / 100;

    var r = X *  3.2406 + Y * -1.5372 + Z * -0.4986;
    var g = X * -0.9689 + Y *  1.8758 + Z *  0.0415;
    var bl = X *  0.0557 + Y * -0.2040 + Z *  1.0570;

    function toChannel(u) {
      if (u <= 0) return 0;
      if (u <= 0.0031308) return Math.round(12.92 * u * 255);
      return Math.round((1.055 * Math.pow(u, 1/2.4) - 0.055) * 255);
    }

    return 'rgb(' + toChannel(r) + ',' + toChannel(g) + ',' + toChannel(bl) + ')';
  }

  /* pilih warna teks kontras */
  function getContrastColor(rgb) {
    var m = rgb.match(/\d+/g).map(Number);
    var lum = 0.299*m[0] + 0.587*m[1] + 0.114*m[2];
    return lum > 128 ? '#000' : '#fff';
  }

  /* ΔE2000 */
  function deltaE2000(L1,a1,b1,L2,a2,b2) {
    var C1 = Math.sqrt(a1*a1 + b1*b1);
    var C2 = Math.sqrt(a2*a2 + b2*b2);
    var avgC = (C1 + C2) / 2.0;

    var G = 0.5 * (1 - Math.sqrt(Math.pow(avgC,7) / (Math.pow(avgC,7) + Math.pow(25,7))));
    var a1p = (1 + G) * a1;
    var a2p = (1 + G) * a2;

    var C1p = Math.sqrt(a1p*a1p + b1*b1);
    var C2p = Math.sqrt(a2p*a2p + b2*b2);

    var h1p = Math.atan2(b1, a1p); if (h1p < 0) h1p += 2*Math.PI;
    var h2p = Math.atan2(b2, a2p); if (h2p < 0) h2p += 2*Math.PI;

    var dLp = L2 - L1;
    var dCp = C2p - C1p;

    var dhp;
    if (C1p * C2p === 0) { dhp = 0; }
    else {
      dhp = h2p - h1p;
      if (dhp > Math.PI) dhp -= 2*Math.PI;
      if (dhp < -Math.PI) dhp += 2*Math.PI;
    }

    var dHp = 2 * Math.sqrt(C1p * C2p) * Math.sin(dhp / 2.0);

    var Lbar = (L1 + L2) / 2.0;
    var Cbarp = (C1p + C2p) / 2.0;

    var hbarp;
    if (C1p*C2p === 0) hbarp = h1p + h2p;
    else {
      if (Math.abs(h1p - h2p) > Math.PI) hbarp = (h1p + h2p + 2*Math.PI) / 2.0;
      else hbarp = (h1p + h2p) / 2.0;
    }

    var T = 1 - 0.17 * Math.cos(hbarp - Math.PI/6) + 0.24 * Math.cos(2*hbarp) + 0.32 * Math.cos(3*hbarp + Math.PI/30) - 0.20 * Math.cos(4*hbarp - 63*Math.PI/180);
    var dTheta = (30 * Math.PI/180) * Math.exp(- Math.pow(((hbarp*180/Math.PI) - 275) / 25, 2));
    var Rc = 2 * Math.sqrt( Math.pow(Cbarp,7) / ( Math.pow(Cbarp,7) + Math.pow(25,7) ) );

    var Sl = 1 + (0.015 * Math.pow(Lbar - 50, 2)) / Math.sqrt(20 + Math.pow(Lbar - 50, 2));
    var Sc = 1 + 0.045 * Cbarp;
    var Sh = 1 + 0.015 * Cbarp * T;

    var Rt = - Math.sin(2 * dTheta) * Rc;

    var termL = Math.pow(dLp / Sl, 2);
    var termC = Math.pow(dCp / Sc, 2);
    var termH = Math.pow(dHp / Sh, 2);
    var termRT = Rt * (dCp / Sc) * (dHp / Sh);

    return Math.sqrt(Math.max(0, termL + termC + termH + termRT));
  }

  /* hitung */
  function hitung() {
    var L1 = parseFloat(document.getElementById('L1').value) || 0;
    var a1 = parseFloat(document.getElementById('a1').value) || 0;
    var b1 = parseFloat(document.getElementById('b1').value) || 0;
    var L2 = parseFloat(document.getElementById('L2').value) || 0;
    var a2 = parseFloat(document.getElementById('a2').value) || 0;
    var b2 = parseFloat(document.getElementById('b2').value) || 0;
    var tol = parseFloat(document.getElementById('tolerance').value);
    if (isNaN(tol)) tol = 2.0;

    var dE = deltaE2000(L1,a1,b1,L2,a2,b2);
    var hasil = document.getElementById('hasil');
    hasil.style.display = "block";

    if (dE <= tol) {
      hasil.className = 'result pass';
      hasil.innerHTML = 'ΔE2000 = ' + dE.toFixed(2) + ' ✅ LULUS';
    } else if (dE <= 3.0) {
      hasil.className = 'result marginal';
      hasil.innerHTML = 'ΔE2000 = ' + dE.toFixed(2) + ' ⚠️ MARGINAL';
    } else {
      hasil.className = 'result fail';
      hasil.innerHTML = 'ΔE2000 = ' + dE.toFixed(2) + ' ❌ GAGAL';
    }

    var col1 = LabToRGB(L1,a1,b1);
    var col2 = LabToRGB(L2,a2,b2);
    document.getElementById('color1').style.background = col1;
    document.getElementById('color1').style.color = getContrastColor(col1);
    document.getElementById('color2').style.background = col2;
    document.getElementById('color2').style.color = getContrastColor(col2);
  }

  /* reset */
  function resetInput() {
    var ids = ['L1','a1','b1','L2','a2','b2'];
    for (var i=0; i<ids.length; i++) {
      var el = document.getElementById(ids[i]);
      if (el) el.value = '';
    }
    document.getElementById('tolerance').value = "2.0";

    var hasil = document.getElementById('hasil');
    hasil.className = 'result';
    hasil.innerHTML = '';
    hasil.style.display = "none";

    document.getElementById('color1').style.background = '#ffffff';
    document.getElementById('color1').style.color = '#000';
    document.getElementById('color2').style.background = '#ffffff';
    document.getElementById('color2').style.color = '#000';
  }
</script>
</body>
</html>
